<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title></title>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript">

var iTimeoutId = null;
var regOn = false;
var allWitnesses;
var newRules;
var witnessList;

String.prototype.reverse=function(){return this.split("").reverse().join("");}

function determineClick()
{
  //alert("Single click received");
  if (iTimeoutId == null || !iTimeoutId)
  {
    iTimeoutId = setTimeout("selectNew()", 500);
  }
  else
  {
    //alert("double clicked");
    window.clearTimeout(iTimeoutId);
    iTimeoutId = null;
    selectToken();
  }
}

function selectToken()
{
    // var txt = document.getElementByName("reg_area");
    var content = document.regularization.reg_area.value;
    var txt = document.regularization.reg_area;
    var startPos = txt.selectionStart;
    var endPos = txt.selectionEnd;
    //alert(startPos + " " + endPos);
    //alert(content.substring(startPost,endPos));
    var reg_word = "";
    var i = 0;
    for(i=startPos; i<endPos; i++)
    {
	reg_word = reg_word + content[i];
    }
    //alert(reg_word);

    // make sure word clicked is not a witness
    var isWitness = false;
    for (var index in allWitnesses.witnesses)
    {
      //alert(allWitnesses.witnesses[index].id);
      if(allWitnesses.witnesses[index].id == reg_word || reg_word == "/"
         || reg_word == "")
      {
        // alert(allWitnesses.witnesses[index].id);
         isWitness = true;
      }
    }
    if (isWitness == false)
    {
      document.regularization.reg_this.value = reg_word;
    }

  // find the witnesses for the chosen text
  // alert(i);
  i++;
  keepSearching=true;
  witnessList = [];
  var witness = "";
  while(keepSearching)
  {
    //alert(content[i]);
    var string = content[i] + content[i+1];
    //alert(string);
    if(string == " /")
    {
       //alert("if");
       keepSearching = false;
       witnessList.push(witness);
       witness = "";
    }
    else if (content[i] == " ")
    {
       //alert("elseif");
       //alert("adding" + witness);
       witnessList.push(witness);
       witness = "";
    }
    else
    {
       witness = witness + content[i];
    }
    i++;
  }
}

function selectNew()
{
  iTimeoutId = null;
  //alert("selectNew");
  var content = document.regularization.reg_area.value;
  var txt = document.regularization.reg_area;
  var pos = txt.selectionStart;
  var right_word = content[pos];

  var i = pos+1;
  //alert(pos + " " + content[pos] + " " + i);
  var keepSearching=true;
  // search to the right
  while(keepSearching)
  {
    if(content[i] != " ")
    {
      right_word = right_word + content[i];
      //alert(content[i] + " " + pos);
    }
    else
    {
      keepSearching=false;
      //right_word = right_word + content[pos];
    }
    i++;
  }

  keepSearching=true;
  i = pos-1;
  var left_word = "";
  // search to the left
  while(keepSearching && i != -1)
  {
    if(content[i] != " ")
    {
      left_word = left_word + content[i];
    }
    else
    {
      keepSearching=false;
    }
    i--;
  }
  //alert(left_word + " " + right_word);
  var reg_word = left_word.reverse() + right_word;
  //alert(reg_word);

  // make sure word clicked is not a witness
    var isWitness = false;
    for (var i in allWitnesses.witnesses)
    {
      //alert(allWitnesses.witnesses[i].id);
      if(allWitnesses.witnesses[i].id == reg_word || reg_word == "/"
         || reg_word == "")
      {
        // alert(allWitnesses.witnesses[i].id);
         isWitness = true;
      }
    }
    if (isWitness == false)
    {
      document.regularization.reg_to.value = reg_word;
    }
  
}

function addrule()
{
  reg_word = document.regularization.reg_this.value;
  reg_to = document.regularization.reg_to.value;
  choice = document.regularization.reg_choices.value;
  //alert(reg_word + " " + reg_to + " " + choice);

  if (reg_word != "" || reg_word != " " || reg_to != "" ||
      reg_word != " ")
  {
    //alert("add rule");
    for( var i in witnessList )
    {
       if (witnessList[i] != "")
       {
         //alert(witnessList[i]);
         newRules.rules.push({
           "_id" : i,
           "appliesTo" : witnessList[i],
           "condition" : "",
           "action" : "regularize(reg_word, reg_to)",
           "user" : "",
           "scope" : choice,
           "regularization_type" : "",
           "description" : "",
           "token" : reg_word,
           "lemma" : ""
         });
       }
    }
  }

  alert("rule added");
}

function regularize_onoff()
{
  //alert("onOff");
  if (regOn == false)
  {
     regOn = true;
     document.getElementById('reg_on').innerHTML = "Regularization is on!";
     alert(regOn);
  }
  else
  {
     regOn = false;
     document.getElementById('reg_on').innerHTML = "Regularization is off!";
     alert(regOn);
  }

}

function load()
{
  //alert("load");
  $.getJSON("http://127.0.0.1:8000/regularization/sample/getWitnesses/",
function(jdata) {

  // save the witnesses to a global variable
  allWitnesses = jdata;
})
.error(function() { alert("error"); });

  //initialize new rules
  newRules = { rules: [] };

}

</script>
</head>

<body onload="load()">
<h1>Regularization: Make Modifications</h1>
Double click on the word you want regularized, single click or type in the
word you want it regularized to.  Select
combination of Witnesses and Place.  Click OK when
finished.
<label for="reg_on" id="reg_on">Regularization is off! (Showing
originals)
</label>

<form action="." method="POST" name="regularization">
        <table>
            {{ form.as_table }}
        </table>
	<input name="ok" type="button" value="Add Rule"
	onclick="addrule()">
	<input name="edit_reg" type="submit" value="Edit Reg.">
	<input name="reg_on" type="button" value="Reg. On"
	onclick="regularize_onoff()">
	<input name="recollate" type="submit"
        value="Recollate">
	<input name="back" type="submit" value="Back">
	<input name="next" type="submit" value="Next">
	<input name="view" type="submit" value="View Originals">
	<input name="done" type="submit" value="DONE">
    </form>




</body> </html>
