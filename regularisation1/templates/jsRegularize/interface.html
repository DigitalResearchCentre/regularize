<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title></title>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript">

var iTimeoutId = null;
var regOn = false;
var allWitnesses;
var newRules;
var allTokens;
var tokenClicked;
var currentPosition;
var boxPos;
var totalPos;
var line1W; var line2W; var line3W; var line4W; var line5W;
var line6W; var line7W; var line8W; var line9W; var line10W;
var line11W;
var regLineW;
var contextStruct;
var allRules;
var newWitnesses;

function determineClick(token)
{
  tokenClicked = token;
  //alert(tokenClicked);
  //alert("Single click received");
  if (iTimeoutId == null || !iTimeoutId)
  {
    iTimeoutId = setTimeout("selectToken()", 500);
  }
  else
  {
    //alert("double clicked");
    window.clearTimeout(iTimeoutId);
    iTimeoutId = null;
    selectNew();
  }
}

function selectToken()
{
    //alert("selectToken");
    var content = "";
    if(tokenClicked == 'token1Text')
    {
      content = document.regularization.token1Text.value;
      regLineW = line1W;
      //alert(content);
    }
    else if(tokenClicked == 'token2Text')
    {
      content = document.regularization.token2Text.value;
      regLineW = line2W;
      //alert(content);
    }
    else if(tokenClicked == 'token3Text')
    {
      content = document.regularization.token3Text.value;
      regLineW = line3W;
      //alert(content);
    }
    else if(tokenClicked == 'token4Text')
    {
      content = document.regularization.token4Text.value;
      regLineW = line4W;
      //alert(content);
    }
    else if(tokenClicked == 'token5Text')
    {
      content = document.regularization.token5Text.value;
      regLineW = line5W;
      //alert(content);
    }
    else if(tokenClicked == 'token6Text')
    {
      content = document.regularization.token6Text.value;
      regLineW = line6W;
      //alert(content);
    }
    else if(tokenClicked == 'token7Text')
    {
      content = document.regularization.token7Text.value;
      regLineW = line7W;
      //alert(content);
    }
    else if(tokenClicked == 'token8Text')
    {
      content = document.regularization.token8Text.value;
      regLineW = line8W;
      //alert(content);
    }
    else if(tokenClicked == 'token9Text')
    {
      content = document.regularization.token9Text.value;
      regLineW = line9W;
      //alert(content);
    }
    else if(tokenClicked == 'token10Text')
    {
      content = document.regularization.token10Text.value;
      regLineW = line10W;
      //alert(content);
    }
    else if(tokenClicked == 'token11Text')
    {
      content = document.regularization.token11Text.value;
      regLineW = line11W;
      //alert(content);
    }

    document.regularization.reg_this.value = content;
}


function selectNew()
{
   //alert("selectNew()");

  var content = "";
    if(tokenClicked == 'token1Text')
    {
      content = document.regularization.token1Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token2Text')
    {
      content = document.regularization.token2Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token3Text')
    {
      content = document.regularization.token3Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token4Text')
    {
      content = document.regularization.token4Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token5Text')
    {
      content = document.regularization.token5Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token6Text')
    {
      content = document.regularization.token6Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token7Text')
    {
      content = document.regularization.token7Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token8Text')
    {
      content = document.regularization.token8Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token9Text')
    {
      content = document.regularization.token9Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token10Text')
    {
      content = document.regularization.token10Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token11Text')
    {
      content = document.regularization.token11Text.value;
      //alert(content);
    }

    document.regularization.reg_to.value = content;
}

function findDistinct(position)
{
  //alert("findDistinct");
  // adding witnesses to the label for the inputs
  var line1 = ""; var line2 = ""; var line3 = ""; var line4 = "";
  var line5 = "" ; var line6 = ""; var line7 = ""; var line8 = "";
  var line9 = ""; var line10 = ""; var line11 = "";

  for (var i in allTokens.alignment)
  {
    //alert(allTokens.alignment[i].witness);

    if(allTokens.alignment[i].tokens[position] == null)
    {
       token = "null";
    }
    else
    {
      token = allTokens.alignment[i].tokens[position].t;
    }
    //alert(token);

    // Wy not collated right
    if (allTokens.alignment[i].witness != "Wy")
    {
    // fill structure that tells what data is in input fields, etc
    if (token == document.regularization.token1Text.value)
    {
       //alert("line1");
       line1 += allTokens.alignment[i].witness + " ";
       line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "1"
       });
    }
    else if (token == document.regularization.token2Text.value)
    {
       // alert("line2");
       line2 += allTokens.alignment[i].witness + " ";
       line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "2"
       });
    }
    else if (token == document.regularization.token3Text.value)
    {
       // alert("line3");
       line3 += allTokens.alignment[i].witness + " ";
       line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "3"
       });
    }
    else if (token == document.regularization.token4Text.value)
    {
       // alert("line4");
       line4 += allTokens.alignment[i].witness + " ";
       line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "4"
       });
    }
    else if (token == document.regularization.token5Text.value)
    {
       // alert("line5");
       line5 += allTokens.alignment[i].witness + " ";
       line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "5"
       });
    }
    else if (token == document.regularization.token6Text.value)
    {
       // alert("line6");
       line6 += allTokens.alignment[i].witness + " ";
       line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "6"
       });
    }
    else if (token == document.regularization.token7Text.value)
    {
       // alert("line7");
       line7 += allTokens.alignment[i].witness + " ";
       line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "7"
       });
    }
    else if (token == document.regularization.token8Text.value)
    {
       // alert("line8");
       line8 += allTokens.alignment[i].witness + " ";
       line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "8"
       });
    }
    else if (token == document.regularization.token9Text.value)
    {
       // alert("line9");
       line9 += allTokens.alignment[i].witness + " ";
       line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "9"
       });
    }
    else if (token == document.regularization.token10Text.value)
    {
       //alert("line10");
       line10 += allTokens.alignment[i].witness + " ";
       line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "10"
       });
    }
    else if (token == document.regularization.token11Text.value)
    {
       //alert("line11");
       line11 += allTokens.alignment[i].witness + " ";
       line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "11"
       });
    }
    else
    {
       // Put the token into the input field
       if(document.regularization.token1Text.value == "")
       {
          //alert("line1");
          line1 += allTokens.alignment[i].witness + " ";
          line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token1Text.value = token;
          document.regularization.token1Text.style.visibility = "visible";
       }
       else if(document.regularization.token2Text.value == "")
       {
          //alert("line2");
          line2 += allTokens.alignment[i].witness + " ";
          line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token2Text.value = token;
          document.regularization.token2Text.style.visibility = "visible";
       }
       else if(document.regularization.token3Text.value == "")
       {
          //alert("line3");
          line3 += allTokens.alignment[i].witness + " ";
          line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token3Text.value = token;
          document.regularization.token3Text.style.visibility = "visible";
       }
       else if(document.regularization.token4Text.value == "")
       {
          // alert("line4");
          line4 += allTokens.alignment[i].witness + " ";
          line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token4Text.value = token;
          document.regularization.token4Text.style.visibility = "visible";
       }
       else if(document.regularization.token5Text.value == "")
       {
         // alert("line5");
          line5 += allTokens.alignment[i].witness + " ";
          line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token5Text.value = token;
          document.regularization.token5Text.style.visibility = "visible";
       }
       else if(document.regularization.token6Text.value == "")
       {
          //alert("line6");
          line6 += allTokens.alignment[i].witness + " ";
          line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token6Text.value = token;
          document.regularization.token6Text.style.visibility = "visible";
       }
       else if(document.regularization.token7Text.value == "")
       {
          //alert("line7");
          line7 += allTokens.alignment[i].witness + " ";
          line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token7Text.value = token;
          document.regularization.token7Text.style.visibility = "visible";
       }
       else if(document.regularization.token8Text.value == "")
       {
         // alert("line8");
          line8 += allTokens.alignment[i].witness + " ";
          line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token8Text.value = token;
          document.regularization.token8Text.style.visibility = "visible";
       }
       else if(document.regularization.token9Text.value == "")
       {
         // alert("line9");
          line9 += allTokens.alignment[i].witness + " ";
          line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token9Text.value = token;
          document.regularization.token9Text.style.visibility = "visible";
       }
       else if(document.regularization.token10Text.value == "")
       {
          // alert("line10");
          line10 += allTokens.alignment[i].witness + " ";
          line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token10Text.value = token;
          document.regularization.token10Text.style.visibility = "visible";
       }
       else if(document.regularization.token11Text.value == "")
       {
          //alert("line11");
          line11 += allTokens.alignment[i].witness + " ";
          line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token11Text.value = token;
          document.regularization.token11Text.style.visibility = "visible";
       }
    }
    }
  }

  document.getElementById('token1').innerHTML = line1;
  document.getElementById('token2').innerHTML = line2;
  document.getElementById('token3').innerHTML = line3;
  document.getElementById('token4').innerHTML = line4;
  document.getElementById('token5').innerHTML = line5;
  document.getElementById('token6').innerHTML = line6;
  document.getElementById('token7').innerHTML = line7;
  document.getElementById('token8').innerHTML = line8;
  document.getElementById('token9').innerHTML = line9;
  document.getElementById('token10').innerHTML = line10;
  document.getElementById('token11').innerHTML = line11;

  //alert("after");
}

function load()
{
  //alert("load");
  $.getJSON("http://127.0.0.1:8000/regularization/interface/getBaseWitnesses/",
function(jdata) {

  // save the witnesses to a global variable
  allWitnesses = jdata;
})
.error(function() { alert("error"); });

  //initialize new rules
  newRules = { rules: [] };

  //initialize structure to hold positions of tokens and witnesses
 // in interface
  boxPos = { witness: [] };

  // initialize lists for lines
  line1W = { witnesses: [] };
  line2W = { witnesses: [] };
  line3W = { witnesses: [] };
  line4W = { witnesses: [] };
  line5W = { witnesses: [] };
  line6W = { witnesses: [] };
  line7W = { witnesses: [] };
  line8W = { witnesses: [] };
  line9W = { witnesses: [] };
  line10W = { witnesses: [] };
  line11W = { witnesses: [] };

  contextStruct = { witnesses: [] };

  $.getJSON("http://127.0.0.1:8000/regularization/interface/getBaseTokens/",
function(jdata) {

  // save the tokens to a global variable
  allTokens = jdata;

  totalPos = 0;

  // find how many positions are in tokens
  for (var i in allTokens.alignment[0].tokens)
  {
     totalPos++;
  }
  //alert(totalPos);

  // put distinct tokens at position 0 into interface
  currentPosition = 1;
  findDistinct(0);
})
.error(function() { alert("error"); });

  // add keyboard shortcut
  shortcut.add("Right", function () {
    //alert("shortcut");
    addTokenThis();
  });

  shortcut.add("Shift+Right", function () {
    addTokenTo();
  });

  shortcut.add("Tab", function() {
    findNextVariant();
  });

}

function findNextVariant() {

  var reg_this = document.regularization.reg_this.value;
  var reg_to = document.regularization.reg_to.value;

  var position = currentPosition - 1;
  var newToken = "";

  if(reg_to == "")
  {
    alert("Please select a token");
  }
  else
  {
     //alert("tokenSelected");
     reg_to = reg_to.split(" ", 1);
     var found = false;
     var foundVariant = false;
     var variant = "";
     for (var i in allTokens.alignment)
     {
       if (allTokens.alignment[i].tokens[position].t == reg_to && !found)
       {
         //alert("found token");
         found = true;
       }
       else if (found && reg_to != allTokens.alignment[i].tokens[position].t && !foundVariant)
       {
         foundVariant = true;
         variant = allTokens.alignment[i].tokens[position].t;
       }
     }
     if(foundVariant)
     {
       document.regularization.reg_this.value = variant;
     }
     else
     {
       alert("Error: Cannot get next variant.");
     } 
   }
  
}

function addTokenTo()
{
  //alert("addToken");

    // if more than one winess, check to see if words are different
    // if words are different -> cannot add next word
    // else add next word to reg_this
    // if reg_on see if rules apply to next word!

  var reg_this = document.regularization.reg_to.value;
  var position = currentPosition - 1;
  var newToken = "";
  if(reg_this == "")
  {
    alert("Please select a token");
  }
  else
  {
     //alert("tokenSelected");
     reg_this = reg_this.split(" ", 1);
     var add = true;
     var found = false;
     var newPosition = currentPosition;
     var regToken = false;
     for (var i in allTokens.alignment)
     {
       if (allTokens.alignment[i].tokens[position].t == reg_this && !found)
       {
         //alert("found token");
         position = position + 1;
         var token = "";
         if(regOn){
         for (var k in allRules.rules)
         {
           //alert(allRules.rules[k].action);
           token = allTokens.alignment[i].tokens[position].t;
           if (token == allRules.rules[k].token)
           {
             alert(allRules.rules[k].action);
             action = allRules.rules[k].action;
             token = action.split(', ')[1];
             token = token.substring(0, token.length-1);
             regToken = true;
             found = true;
             //alert(token);
           }
         }
         if (regToken)
         {
           newToken = token;
         }}
         else
         {
           newToken = allTokens.alignment[i].tokens[position].t;
           found = true;
         }
       }
       else if (allTokens.alignment[i].tokens[position].t == reg_this && found && allTokens.alignment[i].tokens[position].t != newToken)
       {
         add = false;
       }
     }

     if(add)
     {
       document.regularization.reg_to.value = reg_this + " " + newToken;
     }
     else
     {
       alert("Error: Cannot get next token.  Not all next tokens match.");
     } 
  }

}

function addTokenThis()
{
  //alert("addToken");

    // if more than one winess, check to see if words are different
    // if words are different -> cannot add next word
    // else add next word to reg_this
    // if reg_on see if rules apply to next word!

  var reg_this = document.regularization.reg_this.value;
  var position = currentPosition - 1;
  var newToken = "";
  if(reg_this == "")
  {
    alert("Please select a token");
  }
  else
  {
     //alert("tokenSelected");
     reg_this = reg_this.split(" ", 1);
     var add = true;
     var found = false;
     var newPosition = currentPosition;
     var regToken = false;
     for (var i in allTokens.alignment)
     {
       if (allTokens.alignment[i].tokens[position].t == reg_this && !found)
       {
         //alert("found token");
         position = position + 1;
         var token = "";
         if(regOn){
         for (var k in allRules.rules)
         {
           //alert(allRules.rules[k].action);
           token = allTokens.alignment[i].tokens[position].t;
           if (token == allRules.rules[k].token)
           {
             alert(allRules.rules[k].action);
             action = allRules.rules[k].action;
             token = action.split(', ')[1];
             token = token.substring(0, token.length-1);
             regToken = true;
             found = true;
             //alert(token);
           }
         }
         if (regToken)
         {
           newToken = token;
         }}
         else
         {
           newToken = allTokens.alignment[i].tokens[position].t;
           found = true;
         }
       }
       else if (allTokens.alignment[i].tokens[position].t == reg_this && found && allTokens.alignment[i].tokens[position].t != newToken)
       {
         add = false;
       }
     }

     if(add)
     {
       document.regularization.reg_this.value = reg_this + " " +newToken;
     }
     else
     {
       alert("Error: Cannot get next token.  Not all next tokens match.");
     } 
  }

}

function regularize_onoff()
{
  //alert("onOff");
  if (regOn == false)
  {
     regOn = true;
     document.getElementById('reg_on').innerHTML = "Regularization is on!";
     getRules();
     //alert(regOn);
  }
  else
  {
     regOn = false;
     string = "Regularization is off! (Showing originals)";
     document.getElementById('reg_on').innerHTML = string;
      var position;
      if(currentPosition != 0)
      {
        position = currentPosition - 1;
      }
     findDistinct(position);
     //alert(regOn);
  }
}

function getRules()
{
  $.getJSON("http://127.0.0.1:8000/regularization/interface/getRules/",
function(jdata) {

  allRules = jdata;

  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  var position;
  if(currentPosition != 0)
  {
    position = currentPosition - 1;
  }
  regularize(position);
  //alert(allRules.rules[1].action);
  //alert("success");
})
.error(function() { alert("error"); });
}

function regularize(position)
{

  var line1 = ""; var line2 = ""; var line3 = ""; var line4 = "";
  var line5 = "" ; var line6 = ""; var line7 = ""; var line8 = "";
  var line9 = ""; var line10 = ""; var line11 = "";

  var line1Break = true; var line2Break = true; var line3Break = true;
  var line4Break = true; var line5Break = true; var line6Break = true;
  var line7Break = true; var line8Break = true; var line9Break = true;
  var line10Break = true; var line11Break = true;

  var regToken = false;
  var origToken = "";

  //alert("regularize");
  for (var i in allTokens.alignment)
  {

    if(allTokens.alignment[i].tokens[position] == null)
    {
       token = "null";
       origToken = "null";
    }
    else
    {
      token = allTokens.alignment[i].tokens[position].t;
      origToken = allTokens.alignment[i].tokens[position].t;
    }

    //alert(allTokens.alignment[i].witness);
    // regularize token
    for (var k in allRules.rules)
    {
      //alert(allRules.rules[k].action);
      if (token == allRules.rules[k].token)
      {
        //alert(allRules.rules[k].action);
        action = allRules.rules[k].action;
        token = action.split(', ')[1];
        token = token.substring(0, token.length-1);
        regToken = true;
        //alert(token);
      }
    }

    if (token == document.regularization.token1Text.value)
    {
       //alert("line1REPEAT");
       if (regToken)
       {
         line1 += allTokens.alignment[i].witness + "(" + origToken + ") ";
         if (line1.length > 80 && line1Break)
         {
           line1 += "<br />";
           line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
           line1Break = false;
         }
         else if (!line1Break && line1.length > 160)
         {
            line1 += "<br />";
            line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
         }
         else if (!line1Break && line1.length > 240)
         {
            line1 += "<br />";
            line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
         }
       }
       else
       {
         line1 += allTokens.alignment[i].witness + " ";
         if (line1.length > 80 && line1Break)
         {
           line1 += "<br />";
           line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
           line1Break = false;
         }
         else if (!line1Break && line1.length > 160)
         {
            line1 += "<br />";
            line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
         }
         else if (!line1Break && line1.length > 240)
         {
            line1 += "<br />";
            line1 += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
         }
       }
       line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "1"
       });
    }
    else if (token == document.regularization.token2Text.value)
    {
       // alert("line2");
       if (regToken)
       {
         line2 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line2 += allTokens.alignment[i].witness + " ";
       }
       line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "2"
       });
    }
    else if (token == document.regularization.token3Text.value)
    {
       // alert("line3");
       if (regToken)
       {
         line3 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line3 += allTokens.alignment[i].witness + " ";
       }
       line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "3"
       });
    }
    else if (token == document.regularization.token4Text.value)
    {
       // alert("line4");
       if (regToken)
       {
         line4 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line4 += allTokens.alignment[i].witness + " ";
       }
       line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "4"
       });
    }
    else if (token == document.regularization.token5Text.value)
    {
       // alert("line5");
       if (regToken)
       {
         line5 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line5 += allTokens.alignment[i].witness + " ";
       }
       line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "5"
       });
    }
    else if (token == document.regularization.token6Text.value)
    {
       // alert("line6");
       if (regToken)
       {
         line6 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line6 += allTokens.alignment[i].witness + " ";
       }
       line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "6"
       });
    }
    else if (token == document.regularization.token7Text.value)
    {
       // alert("line7");
       if (regToken)
       {
         line7 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line7 += allTokens.alignment[i].witness + " ";
       }
       line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "7"
       });
    }
    else if (token == document.regularization.token8Text.value)
    {
       // alert("line8");
       if (regToken)
       {
         line8 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line8 += allTokens.alignment[i].witness + " ";
       }
       line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "8"
       });
    }
    else if (token == document.regularization.token9Text.value)
    {
       // alert("line9");
       if (regToken)
       {
         line9 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line9 += allTokens.alignment[i].witness + " ";
       }
       line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "9"
       });
    }
    else if (token == document.regularization.token10Text.value)
    {
       //alert("line10");
       if (regToken)
       {
         line10 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line10 += allTokens.alignment[i].witness + " ";
       }
       line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "10"
       });
    }
    else if (token == document.regularization.token11Text.value)
    {
       //alert("line11");
       if (regToken)
       {
         line11 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line11 += allTokens.alignment[i].witness + " ";
       }
       line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "11"
       });
    }
    else
    {
       // Put the token into the input field
       if(document.regularization.token1Text.value == "")
       {
          //alert("line1");
          if (regToken)
          {
            line1 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
            line1 += allTokens.alignment[i].witness + " ";
          }
          line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token1Text.value = token;
          document.regularization.token1Text.style.visibility = "visible";
       }
       else if(document.regularization.token2Text.value == "")
       {
          //alert("line2");
          if (regToken)
          {
           line2 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line2 += allTokens.alignment[i].witness + " ";
          }
          line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token2Text.value = token;
          document.regularization.token2Text.style.visibility = "visible";
       }
       else if(document.regularization.token3Text.value == "")
       {
          //alert("line3");
          if (regToken)
          {
           line3 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line3 += allTokens.alignment[i].witness + " ";
          }
          line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token3Text.value = token;
          document.regularization.token3Text.style.visibility = "visible";
       }
       else if(document.regularization.token4Text.value == "")
       {
          // alert("line4");
          if (regToken)
          {
           line4 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line4 += allTokens.alignment[i].witness + " ";
          }
          line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token4Text.value = token;
          document.regularization.token4Text.style.visibility = "visible";
       }
       else if(document.regularization.token5Text.value == "")
       {
         // alert("line5");
          if (regToken)
          {
           line5 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line5 += allTokens.alignment[i].witness + " ";
          }
          line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token5Text.value = token;
          document.regularization.token5Text.style.visibility = "visible";
       }
       else if(document.regularization.token6Text.value == "")
       {
          //alert("line6");
          if (regToken)
          {
           line6 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line6 += allTokens.alignment[i].witness + " ";
          }
          line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token6Text.value = token;
          document.regularization.token6Text.style.visibility = "visible";
       }
       else if(document.regularization.token7Text.value == "")
       {
          //alert("line7");
          if (regToken)
          {
           line7 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line7 += allTokens.alignment[i].witness + " ";
          }
          line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token7Text.value = token;
          document.regularization.token7Text.style.visibility = "visible";
       }
       else if(document.regularization.token8Text.value == "")
       {
         // alert("line8");
          if (regToken)
          {
           line8 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line8 += allTokens.alignment[i].witness + " ";
          }
          line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token8Text.value = token;
          document.regularization.token8Text.style.visibility = "visible";
       }
       else if(document.regularization.token9Text.value == "")
       {
         // alert("line9");
          if (regToken)
          {
           line9 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line9 += allTokens.alignment[i].witness + " ";
          }
          line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token9Text.value = token;
          document.regularization.token9Text.style.visibility = "visible";
       }
       else if(document.regularization.token10Text.value == "")
       {
          // alert("line10");
          if (regToken)
          {
           line10 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line10 += allTokens.alignment[i].witness + " ";
          }
          line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token10Text.value = token;
          document.regularization.token10Text.style.visibility = "visible";
       }
       else if(document.regularization.token11Text.value == "")
       {
          //alert("line11");
          if (regToken)
          {
           line11 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line11 += allTokens.alignment[i].witness + " ";
          }
          line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token11Text.value = token;
          document.regularization.token11Text.style.visibility = "visible";
       }
    }
  regToken = false;
  }

  document.getElementById('token1').innerHTML = line1;
  document.getElementById('token2').innerHTML = line2;
  document.getElementById('token3').innerHTML = line3;
  document.getElementById('token4').innerHTML = line4;
  document.getElementById('token5').innerHTML = line5;
  document.getElementById('token6').innerHTML = line6;
  document.getElementById('token7').innerHTML = line7;
  document.getElementById('token8').innerHTML = line8;
  document.getElementById('token9').innerHTML = line9;
  document.getElementById('token10').innerHTML = line10;
  document.getElementById('token11').innerHTML = line11;
}

function regularize_regOff(position)
{

  var line1 = ""; var line2 = ""; var line3 = ""; var line4 = "";
  var line5 = "" ; var line6 = ""; var line7 = ""; var line8 = "";
  var line9 = ""; var line10 = ""; var line11 = "";
  var regToken = false;
  var origToken = "";

  //alert("regularize");
  for (var i in allTokens.alignment)
  {

    if(allTokens.alignment[i].tokens[position] == null)
    {
       token = "null";
       origToken = "null";
    }
    else
    {
      token = allTokens.alignment[i].tokens[position].t;
      origToken = allTokens.alignment[i].tokens[position].t;
    }

    //alert(allTokens.alignment[i].witness);
    // regularize token
    for (var k in newRules.rules)
    {
      //alert(newRules.rules[k].action);
      if (token == newRules.rules[k].token)
      {
        //alert(newRules.rules[k].action);
        action = newRules.rules[k].action;
        token = action.split(', ')[1];
        token = token.substring(0, token.length-1);
        regToken = true;
        //alert(token);
      }
    }

    if (token == document.regularization.token1Text.value)
    {
       //alert("line1");
       if (regToken)
       {
         line1 += allTokens.alignment[i].witness + "(" + origToken + ") ";
         if (line1.length > 60)
         {
           line1 += "<br />";
         }
       }
       else
       {
         line1 += allTokens.alignment[i].witness + " ";
         if (line1.length > 60)
         {
           line1 += "<br />";
         }
       }
       line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "1"
       });
    }
    else if (token == document.regularization.token2Text.value)
    {
       // alert("line2");
       if (regToken)
       {
         line2 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line2 += allTokens.alignment[i].witness + " ";
       }
       line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "2"
       });
    }
    else if (token == document.regularization.token3Text.value)
    {
       // alert("line3");
       if (regToken)
       {
         line3 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line3 += allTokens.alignment[i].witness + " ";
       }
       line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "3"
       });
    }
    else if (token == document.regularization.token4Text.value)
    {
       // alert("line4");
       if (regToken)
       {
         line4 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line4 += allTokens.alignment[i].witness + " ";
       }
       line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "4"
       });
    }
    else if (token == document.regularization.token5Text.value)
    {
       // alert("line5");
       if (regToken)
       {
         line5 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line5 += allTokens.alignment[i].witness + " ";
       }
       line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "5"
       });
    }
    else if (token == document.regularization.token6Text.value)
    {
       // alert("line6");
       if (regToken)
       {
         line6 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line6 += allTokens.alignment[i].witness + " ";
       }
       line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "6"
       });
    }
    else if (token == document.regularization.token7Text.value)
    {
       // alert("line7");
       if (regToken)
       {
         line7 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line7 += allTokens.alignment[i].witness + " ";
       }
       line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "7"
       });
    }
    else if (token == document.regularization.token8Text.value)
    {
       // alert("line8");
       if (regToken)
       {
         line8 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line8 += allTokens.alignment[i].witness + " ";
       }
       line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "8"
       });
    }
    else if (token == document.regularization.token9Text.value)
    {
       // alert("line9");
       if (regToken)
       {
         line9 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line9 += allTokens.alignment[i].witness + " ";
       }
       line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "9"
       });
    }
    else if (token == document.regularization.token10Text.value)
    {
       //alert("line10");
       if (regToken)
       {
         line10 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line10 += allTokens.alignment[i].witness + " ";
       }
       line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "10"
       });
    }
    else if (token == document.regularization.token11Text.value)
    {
       //alert("line11");
       if (regToken)
       {
         line11 += allTokens.alignment[i].witness + "(" + origToken + ") ";
       }
       else
       {
         line11 += allTokens.alignment[i].witness + " ";
       }
       line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "11"
       });
    }
    else
    {
       // Put the token into the input field
       if(document.regularization.token1Text.value == "")
       {
          //alert("line1");
          if (regToken)
       {
         line1 += allTokens.alignment[i].witness + "(" + origToken + ") ";
         if (line1.length > 60)
         {
           line1 += "<br />";
         }
       }
       else
       {
         line1 += allTokens.alignment[i].witness + " ";
         if (line1.length > 60)
         {
           line1 += "<br />";
         }
       }
          line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token1Text.value = token;
          document.regularization.token1Text.style.visibility = "visible";
       }
       else if(document.regularization.token2Text.value == "")
       {
          //alert("line2");
          if (regToken)
          {
           line2 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line2 += allTokens.alignment[i].witness + " ";
          }
          line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token2Text.value = token;
          document.regularization.token2Text.style.visibility = "visible";
       }
       else if(document.regularization.token3Text.value == "")
       {
          //alert("line3");
          if (regToken)
          {
           line3 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line3 += allTokens.alignment[i].witness + " ";
          }
          line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token3Text.value = token;
          document.regularization.token3Text.style.visibility = "visible";
       }
       else if(document.regularization.token4Text.value == "")
       {
          // alert("line4");
          if (regToken)
          {
           line4 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line4 += allTokens.alignment[i].witness + " ";
          }
          line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token4Text.value = token;
          document.regularization.token4Text.style.visibility = "visible";
       }
       else if(document.regularization.token5Text.value == "")
       {
         // alert("line5");
          if (regToken)
          {
           line5 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line5 += allTokens.alignment[i].witness + " ";
          }
          line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token5Text.value = token;
          document.regularization.token5Text.style.visibility = "visible";
       }
       else if(document.regularization.token6Text.value == "")
       {
          //alert("line6");
          if (regToken)
          {
           line6 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line6 += allTokens.alignment[i].witness + " ";
          }
          line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token6Text.value = token;
          document.regularization.token6Text.style.visibility = "visible";
       }
       else if(document.regularization.token7Text.value == "")
       {
          //alert("line7");
          if (regToken)
          {
           line7 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line7 += allTokens.alignment[i].witness + " ";
          }
          line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token7Text.value = token;
          document.regularization.token7Text.style.visibility = "visible";
       }
       else if(document.regularization.token8Text.value == "")
       {
         // alert("line8");
          if (regToken)
          {
           line8 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line8 += allTokens.alignment[i].witness + " ";
          }
          line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token8Text.value = token;
          document.regularization.token8Text.style.visibility = "visible";
       }
       else if(document.regularization.token9Text.value == "")
       {
         // alert("line9");
          if (regToken)
          {
           line9 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line9 += allTokens.alignment[i].witness + " ";
          }
          line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token9Text.value = token;
          document.regularization.token9Text.style.visibility = "visible";
       }
       else if(document.regularization.token10Text.value == "")
       {
          // alert("line10");
          if (regToken)
          {
           line10 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line10 += allTokens.alignment[i].witness + " ";
          }
          line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token10Text.value = token;
          document.regularization.token10Text.style.visibility = "visible";
       }
       else if(document.regularization.token11Text.value == "")
       {
          //alert("line11");
          if (regToken)
          {
           line11 += allTokens.alignment[i].witness + "(" + origToken + ") ";
          }
          else
          {
           line11 += allTokens.alignment[i].witness + " ";
          }
          line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token11Text.value = token;
          document.regularization.token11Text.style.visibility = "visible";
       }
    }
  regToken = false;
  }

  document.getElementById('token1').innerHTML = line1;
  document.getElementById('token2').innerHTML = line2;
  document.getElementById('token3').innerHTML = line3;
  document.getElementById('token4').innerHTML = line4;
  document.getElementById('token5').innerHTML = line5;
  document.getElementById('token6').innerHTML = line6;
  document.getElementById('token7').innerHTML = line7;
  document.getElementById('token8').innerHTML = line8;
  document.getElementById('token9').innerHTML = line9;
  document.getElementById('token10').innerHTML = line10;
  document.getElementById('token11').innerHTML = line11;
}


function addrule()
{
  //alert("addrule");

  reg_word = document.regularization.reg_this.value;
  reg_to = document.regularization.reg_to.value;
  choice = document.regularization.reg_choices.value;
  //alert(reg_word + " " + reg_to + " " + choice);

  if (reg_word != "" || reg_word != " " || reg_to != "" ||
      reg_word != " ")
  {
       //alert("add rule");
         // anywhere reg_word is found change to reg_to
         if(choice == "all_places")
         {
          // alert("all_places");
           var action = "regularize(" + reg_word + ", " + reg_to + ")";
           newRules.rules.push({
             "_id" : "1",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
         }
         // everytime the system sees reg_word in this
         // section of text (ex: first line of Canterbury Tales)
         // TODO: need to change applies to once load different lines
         else if(choice == "this_block")
         {
          //alert("this_block");
           var action = "regularize(" + reg_word + ", " + reg_to + ")";
             newRules.rules.push({
             "_id" : "2",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
         }
         // every time reg_word is seen in this context change to
         //  reg_to
         // TODO: need to change appliesTo once load different lines
         else if (choice == "this_word")
         {
           getContext(reg_word);
           // alert(context);
           // alert("this_word");
            for (var k in contextStruct.witnesses)
            {
              var context = contextStruct.witnesses[k].context;
            var action = "regularize(" + context + ", " + reg_to + ")";
            newRules.rules.push({
             "_id" : "3",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
           }
         }
         else
         {
           alert("other");
         }
  }

  sendRule();

  //alert("rule added");

  contextStruct = { witnesses: [] };

  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  var position;
  if(currentPosition != 0)
  {
    position = currentPosition - 1;
  }
  regularize_regOff(position);
}

function getContext(reg_word)
{ 
  //alert("getContext");
  var position = currentPosition-1;
  var context = [];

  // set up structure to find context
  for( var i in regLineW.witnesses)
  {
    var goForward;
    var switchDirections;
    if(currentPosition == 1)
    {
      // cannot go backwards
      goForward = true;
      switchDirections = false;
    }
    else if (currentPosition == totalPos)
    {
      // cannot go forwards
      goForward = false;
      switchDirections = false;
    }
    else
    {
      goForward = true;
      switchDirections = true;
    }
    contextStruct.witnesses.push({
      "id": regLineW.witnesses[i].id,
      "token": reg_word,
      "context": reg_word,
      "tokenPos": position,
      "startPos": position,
      "endPos": position,
      "goForward": goForward,
      "switchDirections": switchDirections
    });
  }

  //alert("afterBuild");

  var needContextStruct = { witnesses: [] };
  for (var i in allWitnesses.witnesses)
  {
    needContextStruct.witnesses.push({
      "id" : allWitnesses.witnesses[i].id,
      "needContext": []});
    //alert(allWitnesses.witnesses[i].id);
    for (var j in contextStruct.witnesses)
    {
      needContextStruct.witnesses[i].needContext.push(true);
    }
  }

  var needContext = true;
  var witness;
  var result;
  while(needContext)
  {
    for (var i in needContextStruct.witnesses)
    {
      for (var l in contextStruct.witnesses)
      {

        // split on any character that isn't A-Z, 0-9, or underscore
        // **Get rid of punctuation
        context = contextStruct.witnesses[l].context;
        context = context.split(/\W/);
        context = context.join(' ');

        // create a regular expression for matching
       var re = new RegExp(context, 'g');
       //alert(re);

      //alert(needContextStruct.witnesses[i].id);

      witness = allWitnesses.witnesses[i].content;
      witness = witness.split(/\W/);
      witness = witness.join(' ');

      result = witness.match(re);
      if(result)
      {
        if(result.length > 1)
        {
          // need context
          //alert("greater");
          var getMore = getMoreContext(allWitnesses.witnesses[i].id, l);
          if(getMore == false)
          {
            needContextStruct.witnesses[i].needContext[l] = false;
          }
        }
        else if (result.length == 1)
        {
          // if it != position -> need context
          token = allTokens.alignment[i].tokens[position].t;
          token = token.split(/\W/);
          token = token.join(' ');
          //alert(token);
          if( !(token.match(re)) )
          {
            // need Context
            //alert("equal dne: " + allWitnesses.witnesses[i].id);
            var getMore = getMoreContext(allWitnesses.witnesses[i].id,
      l);
            if(getMore == false)
            {
              needContextStruct.witnesses[i].needContext[l] = false;
            }
          }
          else
          {
            // in correct place, therefore remove from list
            needContextStruct.witnesses[i].needContext[l] = false;
            //alert("equal equal");
          }
        }
      }
      else
      {
        // no match found, remove from list
        needContextStruct.witnesses[i].needContext[l] = false;
        //alert("no match: " + allWitnesses.witnesses[i].id);
      }
      }
    }

    needContext = false;
    for (var i in needContextStruct.witnesses)
    {
       for (var k in contextStruct.witnesses)
       {
         if(needContextStruct.witnesses[i].needContext[l])
         {
           needContext = true;
         }
       }
    }
   
  }
  
}

function getMoreContext(id, witnessIndex)
{
  //alert("getMoreContext");

  var tokenWitnessIndex;
  for (var i in allWitnesses.witnesses)
  {
    if(allWitnesses.witnesses[i].id == id)
    {
      tokenWitnessIndex = i;
    }
  }

  if(contextStruct.witnesses[witnessIndex].startPos == 1 && contextStruct.witnesses[witnessIndex].maxPos == totalPos)
  {
    // total context
    return false;
  }
  else if (contextStruct.witnesses[witnessIndex].startPos == 1 && contextStruct.witnesses[witnessIndex].endPos != totalPos)
  {
    contextStruct.witnesses[witnessIndex].endPos++;
    contextStruct.witnesses[witnessIndex].context += " " + allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].endPos].t;
    contextStruct.witnesses[witnessIndex].switchDirections = false;
  }
  else if (contextStruct.witnesses[witnessIndex].endPos == totalPos &&
  contextStruct.witnesses[witnessIndex].startPos != 1)
  {
    contextStruct.witnesses[witnessIndex].startPos--;
    contextStruct.witnesses[witnessIndex].context = allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].startPos].t + " " + contextStruct.witnesses[witnessIndex].context;
    contextStruct.witnesses[witnessIndex].switchDirections = false;
  }
  else if (contextStruct.witnesses[witnessIndex].goForward == true &&
contextStruct.witnesses[witnessIndex].endPos != totalPos)
  {
    contextStruct.witnesses[witnessIndex].goForward = false;
    contextStruct.witnesses[witnessIndex].endPos++;
    contextStruct.witnesses[witnessIndex].context += " " + allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].endPos].t;
  }
  else if (contextStruct.witnesses[witnessIndex].goForward == false &&
  contextStruct.witnesses[witnessIndex].startPos != 1)
  {
    contextStruct.witnesses[witnessIndex].goForward = true;
    contextStruct.witnesses[witnessIndex].startPos--;
    contextStruct.witnesses[witnessIndex].context = allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].startPos].t + " " + contextStruct.witnesses[witnessIndex].context;
  }

  return true;
}

function sendRule()
{
  //alert("sendRule");

  $.post("http://127.0.0.1:8000/regularization/interface/saveRules/",
       JSON.stringify(newRules), function(data){
       //alert("success");
     })
   .error(function () {alert("error");});

  //newRules = { rules: [] };

}

function nextToken()
{
  //alert("next");
 
  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  if(currentPosition == totalPos)
  {
    //alert("end of tokens");
    var position = currentPosition - 1;
    if(regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
  else
  {
    if(regOn)
    {
      regularize(currentPosition++);
    }
    else
    {
      findDistinct(currentPosition++);
    }
  }
}

function backToken()
{
  //alert("back");
 
  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  if(currentPosition == 1)
  {
    //alert("beg of tokens");
    var position = 0;
    currentPosition == 1;
    if (regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
  else
  {
    //alert("go back");
    var position = currentPosition - 2;
    currentPosition--;
    if (regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
}

function buildWitnesses()
{
  newWitnesses = { witnesses: [] };

  for (var i in allTokens.alignment)
  {
    var content = "";
    for (var j in allTokens.alignment[i].tokens)
    {
      var token = "";
      if(allTokens.alignment[i].tokens[j] == null)
      {
       token = "null";
      }
      else
      {
        token = allTokens.alignment[i].tokens[j].t;
      }

      //alert("BEFORE: " + token);
      //alert(allTokens.alignment[i].witness);
      // regularize token
      for (var k in allRules.rules)
      {
        //alert(allRules.rules[k].action);
        if (token == allRules.rules[k].token)
        {
          //alert(allRules.rules[k].action);
          action = allRules.rules[k].action;
          token = action.split(', ')[1];
          token = token.substring(0, token.length-1);
          //regToken = true;
          //alert(token);
        }
      }
      //alert("After: " + token);
      content += token + " ";
    }
    //alert (content);
    newWitnesses.witnesses.push ({
      "id": allTokens.alignment[i].witness,
      "content": content
    });
  }

  recollate();
}

function recollate()
{
  $.post("http://127.0.0.1:8000/regularization/interface/recollate/",
       JSON.stringify(newWitnesses), function(data){
       //alert("success");
       alert(data.alignment[0].tokens[2].t);
     })
   .error(function () {alert("error");});
}

/**
 * http://www.openjs.com/scripts/events/keyboard_shortcuts/
 * Version : 2.01.B
 * By Binny V A
 * License : BSD
 */
shortcut = {
	'all_shortcuts':{},//All the shortcuts are stored in this array
	'add': function(shortcut_combination,callback,opt) {
		//Provide a set of default options
		var default_options = {
			'type':'keydown',
			'propagate':false,
			'disable_in_input':false,
			'target':document,
			'keycode':false
		}
		if(!opt) opt = default_options;
		else {
			for(var dfo in default_options) {
				if(typeof opt[dfo] == 'undefined') opt[dfo] = default_options[dfo];
			}
		}

		var ele = opt.target;
		if(typeof opt.target == 'string') ele = document.getElementById(opt.target);
		var ths = this;
		shortcut_combination = shortcut_combination.toLowerCase();

		//The function to be called at keypress
		var func = function(e) {
			e = e || window.event;
			
			if(opt['disable_in_input']) { //Don't enable shortcut keys in Input, Textarea fields
				var element;
				if(e.target) element=e.target;
				else if(e.srcElement) element=e.srcElement;
				if(element.nodeType==3) element=element.parentNode;

				if(element.tagName == 'INPUT' || element.tagName == 'TEXTAREA') return;
			}
	
			//Find Which key is pressed
			if (e.keyCode) code = e.keyCode;
			else if (e.which) code = e.which;
			var character = String.fromCharCode(code).toLowerCase();
			
			if(code == 188) character=","; //If the user presses , when the type is onkeydown
			if(code == 190) character="."; //If the user presses , when the type is onkeydown

			var keys = shortcut_combination.split("+");
			//Key Pressed - counts the number of valid keypresses - if it is same as the number of keys, the shortcut function is invoked
			var kp = 0;
			
			//Work around for stupid Shift key bug created by using lowercase - as a result the shift+num combination was broken
			var shift_nums = {
				"`":"~",
				"1":"!",
				"2":"@",
				"3":"#",
				"4":"$",
				"5":"%",
				"6":"^",
				"7":"&",
				"8":"*",
				"9":"(",
				"0":")",
				"-":"_",
				"=":"+",
				";":":",
				"'":"\"",
				",":"<",
				".":">",
				"/":"?",
				"\\":"|"
			}
			//Special Keys - and their codes
			var special_keys = {
				'esc':27,
				'escape':27,
				'tab':9,
				'space':32,
				'return':13,
				'enter':13,
				'backspace':8,
	
				'scrolllock':145,
				'scroll_lock':145,
				'scroll':145,
				'capslock':20,
				'caps_lock':20,
				'caps':20,
				'numlock':144,
				'num_lock':144,
				'num':144,
				
				'pause':19,
				'break':19,
				
				'insert':45,
				'home':36,
				'delete':46,
				'end':35,
				
				'pageup':33,
				'page_up':33,
				'pu':33,
	
				'pagedown':34,
				'page_down':34,
				'pd':34,
	
				'left':37,
				'up':38,
				'right':39,
				'down':40,
	
				'f1':112,
				'f2':113,
				'f3':114,
				'f4':115,
				'f5':116,
				'f6':117,
				'f7':118,
				'f8':119,
				'f9':120,
				'f10':121,
				'f11':122,
				'f12':123
			}
	
			var modifiers = { 
				shift: { wanted:false, pressed:false},
				ctrl : { wanted:false, pressed:false},
				alt  : { wanted:false, pressed:false},
				meta : { wanted:false, pressed:false}	//Meta is Mac specific
			};
                        
			if(e.ctrlKey)	modifiers.ctrl.pressed = true;
			if(e.shiftKey)	modifiers.shift.pressed = true;
			if(e.altKey)	modifiers.alt.pressed = true;
			if(e.metaKey)   modifiers.meta.pressed = true;
                        
			for(var i=0; k=keys[i],i<keys.length; i++) {
				//Modifiers
				if(k == 'ctrl' || k == 'control') {
					kp++;
					modifiers.ctrl.wanted = true;

				} else if(k == 'shift') {
					kp++;
					modifiers.shift.wanted = true;

				} else if(k == 'alt') {
					kp++;
					modifiers.alt.wanted = true;
				} else if(k == 'meta') {
					kp++;
					modifiers.meta.wanted = true;
				} else if(k.length > 1) { //If it is a special key
					if(special_keys[k] == code) kp++;
					
				} else if(opt['keycode']) {
					if(opt['keycode'] == code) kp++;

				} else { //The special keys did not match
					if(character == k) kp++;
					else {
						if(shift_nums[character] && e.shiftKey) { //Stupid Shift key bug created by using lowercase
							character = shift_nums[character]; 
							if(character == k) kp++;
						}
					}
				}
			}
			
			if(kp == keys.length && 
						modifiers.ctrl.pressed == modifiers.ctrl.wanted &&
						modifiers.shift.pressed == modifiers.shift.wanted &&
						modifiers.alt.pressed == modifiers.alt.wanted &&
						modifiers.meta.pressed == modifiers.meta.wanted) {
				callback(e);
	
				if(!opt['propagate']) { //Stop the event
					//e.cancelBubble is supported by IE - this will kill the bubbling process.
					e.cancelBubble = true;
					e.returnValue = false;
	
					//e.stopPropagation works in Firefox.
					if (e.stopPropagation) {
						e.stopPropagation();
						e.preventDefault();
					}
					return false;
				}
			}
		}
		this.all_shortcuts[shortcut_combination] = {
			'callback':func, 
			'target':ele, 
			'event': opt['type']
		};
		//Attach the function with the event
		if(ele.addEventListener) ele.addEventListener(opt['type'], func, false);
		else if(ele.attachEvent) ele.attachEvent('on'+opt['type'], func);
		else ele['on'+opt['type']] = func;
	},

//Remove the shortcut - just specify the shortcut and I will remove the binding
	'remove':function(shortcut_combination) {
		shortcut_combination = shortcut_combination.toLowerCase();
		var binding = this.all_shortcuts[shortcut_combination];
		delete(this.all_shortcuts[shortcut_combination])
		if(!binding) return;
		var type = binding['event'];
		var ele = binding['target'];
		var callback = binding['callback'];

		if(ele.detachEvent) ele.detachEvent('on'+type, callback);
		else if(ele.removeEventListener) ele.removeEventListener(type, callback, false);
		else ele['on'+type] = false;
	}
}

</script>
</head>

<body onload="load()">
<h1>Regularization: Make Modifications</h1>
Double click on the word you want regularized, single click or type in the
word you want it regularized to.  Select
combination of Witnesses and Place.  Click OK when
finished.
<label for="reg_on" id="reg_on">Regularization is off! (Showing
originals)
</label>

<form action="." method="POST" name="regularization">
       <br /><label id="token1"> </label>
           <input type="text" name="token1Text" size="50"
           onclick="determineClick('token1Text')"
           style="visibility:hidden"/>
        <br /><label id="token2"></label>
           <input type="text" name="token2Text" size="50"
            onclick="determineClick('token2Text')" style="visibility:hidden"/>
       <br /><label id="token3"></label>
           <input type="text" name="token3Text" size="50"
           onclick="determineClick('token3Text')" style="visibility:hidden"/>
       <br /><label id="token4"></label>
           <input type="text" name="token4Text" size="50"
           onclick="determineClick('token4Text')" style="visibility:hidden"/>
       <br /><label id="token5"></label>
           <input type="text" name="token5Text" size="50"
           onclick="determineClick('token5Text')" style="visibility:hidden"/>
       <br /><label id="token6"></label>
           <input type="text" name="token6Text" size="50"
           onclick="determineClick('token6Text')" style="visibility:hidden"/>
       <br /><label id="token7"></label>
           <input type="text" name="token7Text" size="50"
           onclick="determineClick('token7Text')" style="visibility:hidden"/>
       <br /><label id="token8"></label>
           <input type="text" name="token8Text" size="50"
           onclick="determineClick('token8Text')" style="visibility:hidden"/>
       <br /><label id="token9"></label>
           <input type="text" name="token9Text" size="50"
           onclick="determineClick('token9Text')" style="visibility:hidden"/>
       <br /><label id="token10"></label>
           <input type="text" name="token10Text" size="50"
           onclick="determineClick('token10Text')" style="visibility:hidden"/>
       <br /><label id="token11"></label>
           <input type="text" name="token11Text" size="50"
           onclick="determineClick('token11Text')" style="visibility:hidden"/>
           
       <br /><label id="reg_this" name="reg_this">Regularize This:</label>
           <input type="text" name="reg_this" size="100"/>
       <br /><label id="reg_to">To This:</label>
           <input type="text" name="reg_to" size="100"/>

        <p>Regularize Choices:
       <select name="reg_choices">
	  <option value="this_block">All witnesses, this block</option>
	  <option value="this_word">All witnesses, this word</option>
	  <option value="all_places">All witnesses, all places</option>
	  <option value="other">Other ...</option>
	</select></p>

	<input name="ok" type="button" value="Add Rule"
	onclick="addrule()">
	<input name="edit_reg" type="button" value="Edit Reg.">
	<input name="reg_on" type="button" value="Reg. On"
	onclick="regularize_onoff()">
	<input name="recollate" type="button"
        value="Recollate" onclick="buildWitnesses()">
	<input name="back" type="button" value="Back" onclick="backToken()">
	<input name="next" type="button" value="Next" onclick="nextToken()">
	<input name="view" type="button" value="View Entire Reg.">
	<input name="done" type="button" value="DONE">
	<br /> Shortcuts:: <br/>"Right Arrow": Add next word to Regularize This
	<br /> "Shift+Right Arrow": Add next word to Regularize To
	<br /> "Tab": Find next variant to regularize
	<br /> <input type="checkbox" name="automate" value="automate"
	/> Automate regularization selection
	<br /> <input type="checkbox" name="punctuation" value="punctuation"
	/> No punctuation
    </form>

</body> </html>
