<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title></title>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script type="text/javascript">

var iTimeoutId = null;
var regOn = false;
var allWitnesses;
var newRules;
var allTokens;
var tokenClicked;
var currentPosition;
var boxPos;
var totalPos;
var line1W; var line2W; var line3W; var line4W; var line5W;
var line6W; var line7W; var line8W; var line9W; var line10W;
var line11W;
var regLineW;
var contextStruct;
var allRules;

function determineClick(token)
{
  tokenClicked = token;
  //alert(tokenClicked);
  //alert("Single click received");
  if (iTimeoutId == null || !iTimeoutId)
  {
    iTimeoutId = setTimeout("selectToken()", 500);
  }
  else
  {
    //alert("double clicked");
    window.clearTimeout(iTimeoutId);
    iTimeoutId = null;
    selectNew();
  }
}

function selectToken()
{
    //alert("selectToken");
    var content = "";
    if(tokenClicked == 'token1Text')
    {
      content = document.regularization.token1Text.value;
      regLineW = line1W;
      //alert(content);
    }
    else if(tokenClicked == 'token2Text')
    {
      content = document.regularization.token2Text.value;
      regLineW = line2W;
      //alert(content);
    }
    else if(tokenClicked == 'token3Text')
    {
      content = document.regularization.token3Text.value;
      regLineW = line3W;
      //alert(content);
    }
    else if(tokenClicked == 'token4Text')
    {
      content = document.regularization.token4Text.value;
      regLineW = line4W;
      //alert(content);
    }
    else if(tokenClicked == 'token5Text')
    {
      content = document.regularization.token5Text.value;
      regLineW = line5W;
      //alert(content);
    }
    else if(tokenClicked == 'token6Text')
    {
      content = document.regularization.token6Text.value;
      regLineW = line6W;
      //alert(content);
    }
    else if(tokenClicked == 'token7Text')
    {
      content = document.regularization.token7Text.value;
      regLineW = line7W;
      //alert(content);
    }
    else if(tokenClicked == 'token8Text')
    {
      content = document.regularization.token8Text.value;
      regLineW = line8W;
      //alert(content);
    }
    else if(tokenClicked == 'token9Text')
    {
      content = document.regularization.token9Text.value;
      regLineW = line9W;
      //alert(content);
    }
    else if(tokenClicked == 'token10Text')
    {
      content = document.regularization.token10Text.value;
      regLineW = line10W;
      //alert(content);
    }
    else if(tokenClicked == 'token11Text')
    {
      content = document.regularization.token11Text.value;
      regLineW = line11W;
      //alert(content);
    }

    document.regularization.reg_this.value = content;
}


function selectNew()
{
   //alert("selectNew()");

  var content = "";
    if(tokenClicked == 'token1Text')
    {
      content = document.regularization.token1Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token2Text')
    {
      content = document.regularization.token2Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token3Text')
    {
      content = document.regularization.token3Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token4Text')
    {
      content = document.regularization.token4Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token5Text')
    {
      content = document.regularization.token5Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token6Text')
    {
      content = document.regularization.token6Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token7Text')
    {
      content = document.regularization.token7Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token8Text')
    {
      content = document.regularization.token8Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token9Text')
    {
      content = document.regularization.token9Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token10Text')
    {
      content = document.regularization.token10Text.value;
      //alert(content);
    }
    else if(tokenClicked == 'token11Text')
    {
      content = document.regularization.token11Text.value;
      //alert(content);
    }

    document.regularization.reg_to.value = content;
}

function findDistinct(position)
{
  //alert("findDistinct");
  // adding witnesses to the label for the inputs
  var line1 = ""; var line2 = ""; var line3 = ""; var line4 = "";
  var line5 = "" ; var line6 = ""; var line7 = ""; var line8 = "";
  var line9 = ""; var line10 = ""; var line11 = "";

  for (var i in allTokens.alignment)
  {
    //alert(allTokens.alignment[i].witness);

    if(allTokens.alignment[i].tokens[position] == null)
    {
       token = "null";
    }
    else
    {
      token = allTokens.alignment[i].tokens[position].t;
    }
    //alert(token);

    // Wy not collated right
    if (allTokens.alignment[i].witness != "Wy")
    {
    // fill structure that tells what data is in input fields, etc
    if (token == document.regularization.token1Text.value)
    {
       //alert("line1");
       line1 += allTokens.alignment[i].witness + " ";
       line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "1"
       });
    }
    else if (token == document.regularization.token2Text.value)
    {
       // alert("line2");
       line2 += allTokens.alignment[i].witness + " ";
       line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "2"
       });
    }
    else if (token == document.regularization.token3Text.value)
    {
       // alert("line3");
       line3 += allTokens.alignment[i].witness + " ";
       line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "3"
       });
    }
    else if (token == document.regularization.token4Text.value)
    {
       // alert("line4");
       line4 += allTokens.alignment[i].witness + " ";
       line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "4"
       });
    }
    else if (token == document.regularization.token5Text.value)
    {
       // alert("line5");
       line5 += allTokens.alignment[i].witness + " ";
       line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "5"
       });
    }
    else if (token == document.regularization.token6Text.value)
    {
       // alert("line6");
       line6 += allTokens.alignment[i].witness + " ";
       line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "6"
       });
    }
    else if (token == document.regularization.token7Text.value)
    {
       // alert("line7");
       line7 += allTokens.alignment[i].witness + " ";
       line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "7"
       });
    }
    else if (token == document.regularization.token8Text.value)
    {
       // alert("line8");
       line8 += allTokens.alignment[i].witness + " ";
       line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "8"
       });
    }
    else if (token == document.regularization.token9Text.value)
    {
       // alert("line9");
       line9 += allTokens.alignment[i].witness + " ";
       line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "9"
       });
    }
    else if (token == document.regularization.token10Text.value)
    {
       //alert("line10");
       line10 += allTokens.alignment[i].witness + " ";
       line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "10"
       });
    }
    else if (token == document.regularization.token11Text.value)
    {
       //alert("line11");
       line11 += allTokens.alignment[i].witness + " ";
       line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "11"
       });
    }
    else
    {
       // Put the token into the input field
       if(document.regularization.token1Text.value == "")
       {
          //alert("line1");
          line1 += allTokens.alignment[i].witness + " ";
          line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token1Text.value = token;
          document.regularization.token1Text.style.visibility = "visible";
       }
       else if(document.regularization.token2Text.value == "")
       {
          //alert("line2");
          line2 += allTokens.alignment[i].witness + " ";
          line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token2Text.value = token;
          document.regularization.token2Text.style.visibility = "visible";
       }
       else if(document.regularization.token3Text.value == "")
       {
          //alert("line3");
          line3 += allTokens.alignment[i].witness + " ";
          line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token3Text.value = token;
          document.regularization.token3Text.style.visibility = "visible";
       }
       else if(document.regularization.token4Text.value == "")
       {
          // alert("line4");
          line4 += allTokens.alignment[i].witness + " ";
          line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token4Text.value = token;
          document.regularization.token4Text.style.visibility = "visible";
       }
       else if(document.regularization.token5Text.value == "")
       {
         // alert("line5");
          line5 += allTokens.alignment[i].witness + " ";
          line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token5Text.value = token;
          document.regularization.token5Text.style.visibility = "visible";
       }
       else if(document.regularization.token6Text.value == "")
       {
          //alert("line6");
          line6 += allTokens.alignment[i].witness + " ";
          line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token6Text.value = token;
          document.regularization.token6Text.style.visibility = "visible";
       }
       else if(document.regularization.token7Text.value == "")
       {
          //alert("line7");
          line7 += allTokens.alignment[i].witness + " ";
          line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token7Text.value = token;
          document.regularization.token7Text.style.visibility = "visible";
       }
       else if(document.regularization.token8Text.value == "")
       {
         // alert("line8");
          line8 += allTokens.alignment[i].witness + " ";
          line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token8Text.value = token;
          document.regularization.token8Text.style.visibility = "visible";
       }
       else if(document.regularization.token9Text.value == "")
       {
         // alert("line9");
          line9 += allTokens.alignment[i].witness + " ";
          line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token9Text.value = token;
          document.regularization.token9Text.style.visibility = "visible";
       }
       else if(document.regularization.token10Text.value == "")
       {
          // alert("line10");
          line10 += allTokens.alignment[i].witness + " ";
          line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token10Text.value = token;
          document.regularization.token10Text.style.visibility = "visible";
       }
       else if(document.regularization.token11Text.value == "")
       {
          //alert("line11");
          line11 += allTokens.alignment[i].witness + " ";
          line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token11Text.value = token;
          document.regularization.token11Text.style.visibility = "visible";
       }
    }
    }
  }

  document.getElementById('token1').innerHTML = line1;
  document.getElementById('token2').innerHTML = line2;
  document.getElementById('token3').innerHTML = line3;
  document.getElementById('token4').innerHTML = line4;
  document.getElementById('token5').innerHTML = line5;
  document.getElementById('token6').innerHTML = line6;
  document.getElementById('token7').innerHTML = line7;
  document.getElementById('token8').innerHTML = line8;
  document.getElementById('token9').innerHTML = line9;
  document.getElementById('token10').innerHTML = line10;
  document.getElementById('token11').innerHTML = line11;

  //alert("after");
}

function load()
{
  //alert("load");
  $.getJSON("http://127.0.0.1:8000/regularization/interface/getBaseWitnesses/",
function(jdata) {

  // save the witnesses to a global variable
  allWitnesses = jdata;
})
.error(function() { alert("error"); });

  //initialize new rules
  newRules = { rules: [] };

  //initialize structure to hold positions of tokens and witnesses
 // in interface
  boxPos = { witness: [] };

  // initialize lists for lines
  line1W = { witnesses: [] };
  line2W = { witnesses: [] };
  line3W = { witnesses: [] };
  line4W = { witnesses: [] };
  line5W = { witnesses: [] };
  line6W = { witnesses: [] };
  line7W = { witnesses: [] };
  line8W = { witnesses: [] };
  line9W = { witnesses: [] };
  line10W = { witnesses: [] };
  line11W = { witnesses: [] };

  contextStruct = { witnesses: [] };

  $.getJSON("http://127.0.0.1:8000/regularization/interface/getBaseTokens/",
function(jdata) {

  // save the tokens to a global variable
  allTokens = jdata;

  totalPos = 0;

  // find how many positions are in tokens
  for (var i in allTokens.alignment[0].tokens)
  {
     totalPos++;
  }
  //alert(totalPos);

  // put distinct tokens at position 0 into interface
  currentPosition = 1;
  findDistinct(0);
})
.error(function() { alert("error"); });

}

function regularize_onoff()
{
  //alert("onOff");
  if (regOn == false)
  {
     regOn = true;
     document.getElementById('reg_on').innerHTML = "Regularization is on!";
     getRules();
     //alert(regOn);
  }
  else
  {
     regOn = false;
     string = "Regularization is off! (Showing originals)";
     document.getElementById('reg_on').innerHTML = string;
      var position;
      if(currentPosition != 0)
      {
        position = currentPosition - 1;
      }
     findDistinct(position);
     //alert(regOn);
  }
}

function getRules()
{
  $.getJSON("http://127.0.0.1:8000/regularization/interface/getRules/",
function(jdata) {

  allRules = jdata;

  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  var position;
  if(currentPosition != 0)
  {
    position = currentPosition - 1;
  }
  regularize(position);
  //alert(allRules.rules[1].action);
  //alert("success");
})
.error(function() { alert("error"); });
}

function regularize(position)
{

  var line1 = ""; var line2 = ""; var line3 = ""; var line4 = "";
  var line5 = "" ; var line6 = ""; var line7 = ""; var line8 = "";
  var line9 = ""; var line10 = ""; var line11 = "";
  var regToken = false;

  //alert("regularize");
  for (var i in allTokens.alignment)
  {

    if(allTokens.alignment[i].tokens[position] == null)
    {
       token = "null";
    }
    else
    {
      token = allTokens.alignment[i].tokens[position].t;
    }

    //alert(allTokens.alignment[i].witness);
    // regularize token
    for (var k in allRules.rules)
    {
      //alert(allRules.rules[k].action);
      if (token == allRules.rules[k].token)
      {
        //alert(allRules.rules[k].action);
        action = allRules.rules[k].action;
        token = action.split(', ')[1];
        token = token.substring(0, token.length-1);
        regToken = true;
        //alert(token);
      }
    }

    if (token == document.regularization.token1Text.value)
    {
       //alert("line1");
       if (regToken)
       {
         line1 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line1 += allTokens.alignment[i].witness + " ";
       }
       line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "1"
       });
    }
    else if (token == document.regularization.token2Text.value)
    {
       // alert("line2");
       if (regToken)
       {
         line2 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line2 += allTokens.alignment[i].witness + " ";
       }
       line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "2"
       });
    }
    else if (token == document.regularization.token3Text.value)
    {
       // alert("line3");
       if (regToken)
       {
         line3 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line3 += allTokens.alignment[i].witness + " ";
       }
       line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "3"
       });
    }
    else if (token == document.regularization.token4Text.value)
    {
       // alert("line4");
       if (regToken)
       {
         line4 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line4 += allTokens.alignment[i].witness + " ";
       }
       line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "4"
       });
    }
    else if (token == document.regularization.token5Text.value)
    {
       // alert("line5");
       if (regToken)
       {
         line5 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line5 += allTokens.alignment[i].witness + " ";
       }
       line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "5"
       });
    }
    else if (token == document.regularization.token6Text.value)
    {
       // alert("line6");
       if (regToken)
       {
         line6 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line6 += allTokens.alignment[i].witness + " ";
       }
       line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "6"
       });
    }
    else if (token == document.regularization.token7Text.value)
    {
       // alert("line7");
       if (regToken)
       {
         line7 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line7 += allTokens.alignment[i].witness + " ";
       }
       line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "7"
       });
    }
    else if (token == document.regularization.token8Text.value)
    {
       // alert("line8");
       if (regToken)
       {
         line8 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line8 += allTokens.alignment[i].witness + " ";
       }
       line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "8"
       });
    }
    else if (token == document.regularization.token9Text.value)
    {
       // alert("line9");
       if (regToken)
       {
         line9 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line9 += allTokens.alignment[i].witness + " ";
       }
       line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "9"
       });
    }
    else if (token == document.regularization.token10Text.value)
    {
       //alert("line10");
       if (regToken)
       {
         line10 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line10 += allTokens.alignment[i].witness + " ";
       }
       line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "10"
       });
    }
    else if (token == document.regularization.token11Text.value)
    {
       //alert("line11");
       if (regToken)
       {
         line11 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line11 += allTokens.alignment[i].witness + " ";
       }
       line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
       boxPos.witness.push({
          "id" : allTokens.alignment[i].witness,
          "token" : token,
          "position" : "11"
       });
    }
    else
    {
       // Put the token into the input field
       if(document.regularization.token1Text.value == "")
       {
          //alert("line1");
          if (regToken)
       {
         line1 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
       }
       else
       {
         line1 += allTokens.alignment[i].witness + " ";
       }
          line1W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token1Text.value = token;
          document.regularization.token1Text.style.visibility = "visible";
       }
       else if(document.regularization.token2Text.value == "")
       {
          //alert("line2");
          if (regToken)
          {
           line2 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line2 += allTokens.alignment[i].witness + " ";
          }
          line2W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token2Text.value = token;
          document.regularization.token2Text.style.visibility = "visible";
       }
       else if(document.regularization.token3Text.value == "")
       {
          //alert("line3");
          if (regToken)
          {
           line3 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line3 += allTokens.alignment[i].witness + " ";
          }
          line3W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token3Text.value = token;
          document.regularization.token3Text.style.visibility = "visible";
       }
       else if(document.regularization.token4Text.value == "")
       {
          // alert("line4");
          if (regToken)
          {
           line4 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line4 += allTokens.alignment[i].witness + " ";
          }
          line4W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token4Text.value = token;
          document.regularization.token4Text.style.visibility = "visible";
       }
       else if(document.regularization.token5Text.value == "")
       {
         // alert("line5");
          if (regToken)
          {
           line5 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line5 += allTokens.alignment[i].witness + " ";
          }
          line5W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token5Text.value = token;
          document.regularization.token5Text.style.visibility = "visible";
       }
       else if(document.regularization.token6Text.value == "")
       {
          //alert("line6");
          if (regToken)
          {
           line6 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line6 += allTokens.alignment[i].witness + " ";
          }
          line6W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token6Text.value = token;
          document.regularization.token6Text.style.visibility = "visible";
       }
       else if(document.regularization.token7Text.value == "")
       {
          //alert("line7");
          if (regToken)
          {
           line7 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line7 += allTokens.alignment[i].witness + " ";
          }
          line7W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token7Text.value = token;
          document.regularization.token7Text.style.visibility = "visible";
       }
       else if(document.regularization.token8Text.value == "")
       {
         // alert("line8");
          if (regToken)
          {
           line8 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line8 += allTokens.alignment[i].witness + " ";
          }
          line8W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token8Text.value = token;
          document.regularization.token8Text.style.visibility = "visible";
       }
       else if(document.regularization.token9Text.value == "")
       {
         // alert("line9");
          if (regToken)
          {
           line9 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line9 += allTokens.alignment[i].witness + " ";
          }
          line9W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token9Text.value = token;
          document.regularization.token9Text.style.visibility = "visible";
       }
       else if(document.regularization.token10Text.value == "")
       {
          // alert("line10");
          if (regToken)
          {
           line10 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line10 += allTokens.alignment[i].witness + " ";
          }
          line10W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token10Text.value = token;
          document.regularization.token10Text.style.visibility = "visible";
       }
       else if(document.regularization.token11Text.value == "")
       {
          //alert("line11");
          if (regToken)
          {
           line11 += allTokens.alignment[i].witness + "(" + allTokens.alignment[i].tokens[position].t + ") ";
          }
          else
          {
           line11 += allTokens.alignment[i].witness + " ";
          }
          line11W.witnesses.push({ "id": allTokens.alignment[i].witness});
          document.regularization.token11Text.value = token;
          document.regularization.token11Text.style.visibility = "visible";
       }
    }
  regToken = false;
  }

  document.getElementById('token1').innerHTML = line1;
  document.getElementById('token2').innerHTML = line2;
  document.getElementById('token3').innerHTML = line3;
  document.getElementById('token4').innerHTML = line4;
  document.getElementById('token5').innerHTML = line5;
  document.getElementById('token6').innerHTML = line6;
  document.getElementById('token7').innerHTML = line7;
  document.getElementById('token8').innerHTML = line8;
  document.getElementById('token9').innerHTML = line9;
  document.getElementById('token10').innerHTML = line10;
  document.getElementById('token11').innerHTML = line11;
}


function addrule()
{
  //alert("addrule");

  reg_word = document.regularization.reg_this.value;
  reg_to = document.regularization.reg_to.value;
  choice = document.regularization.reg_choices.value;
  //alert(reg_word + " " + reg_to + " " + choice);

  if (reg_word != "" || reg_word != " " || reg_to != "" ||
      reg_word != " ")
  {
       //alert("add rule");
         // anywhere reg_word is found change to reg_to
         if(choice == "all_places")
         {
          // alert("all_places");
           var action = "regularize(" + reg_word + ", " + reg_to + ")";
           newRules.rules.push({
             "_id" : "1",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
         }
         // everytime the system sees reg_word in this
         // section of text (ex: first line of Canterbury Tales)
         // TODO: need to change applies to once load different lines
         else if(choice == "this_block")
         {
          //alert("this_block");
           var action = "regularize(" + reg_word + ", " + reg_to + ")";
             newRules.rules.push({
             "_id" : "2",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
         }
         // every time reg_word is seen in this context change to
         //  reg_to
         // TODO: need to change appliesTo once load different lines
         else if (choice == "this_word")
         {
           getContext(reg_word);
           // alert(context);
           // alert("this_word");
            for (var k in contextStruct.witnesses)
            {
              var context = contextStruct.witnesses[k].context;
            var action = "regularize(" + context + ", " + reg_to + ")";
            newRules.rules.push({
             "_id" : "3",
             "appliesTo" : "",
             "condition" : "",
             "action" : action,
             "user" : "",
             "scope" : choice,
             "regularization_type" : "",
             "description" : "",
             "token" : reg_word,
             "lemma" : ""
           });
           }
         }
         else
         {
           alert("other");
         }
  }

  sendRule();

  //alert("rule added");

  contextStruct = { witnesses: [] };
}

function getContext(reg_word)
{ 
  //alert("getContext");
  var position = currentPosition-1;
  var context = [];

  // set up structure to find context
  for( var i in regLineW.witnesses)
  {
    var goForward;
    var switchDirections;
    if(currentPosition == 1)
    {
      // cannot go backwards
      goForward = true;
      switchDirections = false;
    }
    else if (currentPosition == totalPos)
    {
      // cannot go forwards
      goForward = false;
      switchDirections = false;
    }
    else
    {
      goForward = true;
      switchDirections = true;
    }
    contextStruct.witnesses.push({
      "id": regLineW.witnesses[i].id,
      "token": reg_word,
      "context": reg_word,
      "tokenPos": position,
      "startPos": position,
      "endPos": position,
      "goForward": goForward,
      "switchDirections": switchDirections
    });
  }

  //alert("afterBuild");

  var needContextStruct = { witnesses: [] };
  for (var i in allWitnesses.witnesses)
  {
    needContextStruct.witnesses.push({
      "id" : allWitnesses.witnesses[i].id,
      "needContext": []});
    //alert(allWitnesses.witnesses[i].id);
    for (var j in contextStruct.witnesses)
    {
      needContextStruct.witnesses[i].needContext.push(true);
    }
  }

  var needContext = true;
  var witness;
  var result;
  while(needContext)
  {
    for (var i in needContextStruct.witnesses)
    {
      for (var l in contextStruct.witnesses)
      {

        // split on any character that isn't A-Z, 0-9, or underscore
        // **Get rid of punctuation
        context = contextStruct.witnesses[l].context;
        context = context.split(/\W/);
        context = context.join(' ');

        // create a regular expression for matching
       var re = new RegExp(context, 'g');
       //alert(re);

      //alert(needContextStruct.witnesses[i].id);

      witness = allWitnesses.witnesses[i].content;
      witness = witness.split(/\W/);
      witness = witness.join(' ');

      result = witness.match(re);
      if(result)
      {
        if(result.length > 1)
        {
          // need context
          //alert("greater");
          var getMore = getMoreContext(allWitnesses.witnesses[i].id, l);
          if(getMore == false)
          {
            needContextStruct.witnesses[i].needContext[l] = false;
          }
        }
        else if (result.length == 1)
        {
          // if it != position -> need context
          token = allTokens.alignment[i].tokens[position].t;
          token = token.split(/\W/);
          token = token.join(' ');
          //alert(token);
          if( !(token.match(re)) )
          {
            // need Context
            //alert("equal dne: " + allWitnesses.witnesses[i].id);
            var getMore = getMoreContext(allWitnesses.witnesses[i].id,
      l);
            if(getMore == false)
            {
              needContextStruct.witnesses[i].needContext[l] = false;
            }
          }
          else
          {
            // in correct place, therefore remove from list
            needContextStruct.witnesses[i].needContext[l] = false;
            //alert("equal equal");
          }
        }
      }
      else
      {
        // no match found, remove from list
        needContextStruct.witnesses[i].needContext[l] = false;
        //alert("no match: " + allWitnesses.witnesses[i].id);
      }
      }
    }

    needContext = false;
    for (var i in needContextStruct.witnesses)
    {
       for (var k in contextStruct.witnesses)
       {
         if(needContextStruct.witnesses[i].needContext[l])
         {
           needContext = true;
         }
       }
    }
   
  }
  
}

function getMoreContext(id, witnessIndex)
{
  //alert("getMoreContext");

  var tokenWitnessIndex;
  for (var i in allWitnesses.witnesses)
  {
    if(allWitnesses.witnesses[i].id == id)
    {
      tokenWitnessIndex = i;
    }
  }

  if(contextStruct.witnesses[witnessIndex].startPos == 1 &&
contextStruct.witnesses[witnessIndex].maxPos == totalPos)
  {
    // total context
    return false;
  }
  else if (contextStruct.witnesses[witnessIndex].startPos == 1 &&
contextStruct.witnesses[witnessIndex].endPos != totalPos)
  {
    contextStruct.witnesses[witnessIndex].endPos++;
    contextStruct.witnesses[witnessIndex].context += " " +
allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].endPos].t;
    contextStruct.witnesses[witnessIndex].switchDirections = false;
  }
  else if (contextStruct.witnesses[witnessIndex].endPos == totalPos &&
contextStruct.witnesses[witnessIndex].startPos != 1)
  {
    contextStruct.witnesses[witnessIndex].startPos--;
    contextStruct.witnesses[witnessIndex].context =
allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].startPos].t
+ " " + contextStruct.witnesses[witnessIndex].context;
    contextStruct.witnesses[witnessIndex].switchDirections = false;
  }
  else if (contextStruct.witnesses[witnessIndex].goForward == true &&
contextStruct.witnesses[witnessIndex].endPos != totalPos)
  {
    contextStruct.witnesses[witnessIndex].goForward = false;
    contextStruct.witnesses[witnessIndex].endPos++;
    contextStruct.witnesses[witnessIndex].context += " " +
allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].endPos].t;
  }
  else if (contextStruct.witnesses[witnessIndex].goForward == false &&
contextStruct.witnesses[witnessIndex].startPos != 1)
  {
    contextStruct.witnesses[witnessIndex].goForward = true;
    contextStruct.witnesses[witnessIndex].startPos--;
    contextStruct.witnesses[witnessIndex].context = allTokens.alignment[tokenWitnessIndex].tokens[contextStruct.witnesses[witnessIndex].startPos].t
+ " " + contextStruct.witnesses[witnessIndex].context;
  }

  return true;
}

function sendRule()
{
  //alert("sendRule");

  $.post("http://127.0.0.1:8000/regularization/interface/saveRules/",
       JSON.stringify(newRules), function(data){
       //alert("success");
     })
   .error(function () {alert("error");});

  newRules = { rules: [] };

}

function nextToken()
{
  //alert("next");
 
  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  if(currentPosition == totalPos)
  {
    //alert("end of tokens");
    var position = currentPosition - 1;
    if(regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
  else
  {
    if(regOn)
    {
      regularize(currentPosition++);
    }
    else
    {
      findDistinct(currentPosition++);
    }
  }
}

function backToken()
{
  //alert("back");
 
  document.getElementById('token1').innerHTML = "";
  document.getElementById('token2').innerHTML = "";
  document.getElementById('token3').innerHTML = "";
  document.getElementById('token4').innerHTML = "";
  document.getElementById('token5').innerHTML = "";
  document.getElementById('token6').innerHTML = "";
  document.getElementById('token7').innerHTML = "";
  document.getElementById('token8').innerHTML = "";
  document.getElementById('token9').innerHTML = "";
  document.getElementById('token10').innerHTML = "";
  document.getElementById('token11').innerHTML = "";

  document.regularization.token1Text.style.visibility = "hidden";
  document.regularization.token2Text.style.visibility = "hidden";
  document.regularization.token3Text.style.visibility = "hidden";
  document.regularization.token4Text.style.visibility = "hidden";
  document.regularization.token5Text.style.visibility = "hidden";
  document.regularization.token6Text.style.visibility = "hidden";
  document.regularization.token7Text.style.visibility = "hidden";
  document.regularization.token8Text.style.visibility = "hidden";
  document.regularization.token9Text.style.visibility = "hidden";
  document.regularization.token10Text.style.visibility = "hidden";
  document.regularization.token11Text.style.visibility = "hidden";

  document.regularization.token1Text.value = "";
  document.regularization.token2Text.value = "";
  document.regularization.token3Text.value = "";
  document.regularization.token4Text.value = "";
  document.regularization.token5Text.value = "";
  document.regularization.token6Text.value = "";
  document.regularization.token7Text.value = "";
  document.regularization.token8Text.value = "";
  document.regularization.token9Text.value = "";
  document.regularization.token10Text.value = "";
  document.regularization.token11Text.value = "";

  document.regularization.reg_this.value = "";
  document.regularization.reg_to.value = "";

  if(currentPosition == 1)
  {
    //alert("beg of tokens");
    var position = 0;
    currentPosition == 1;
    if (regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
  else
  {
    //alert("go back");
    var position = currentPosition - 2;
    currentPosition--;
    if (regOn)
    {
      regularize(position);
    }
    else
    {
      findDistinct(position);
    }
  }
}

</script>
</head>

<body onload="load()">
<h1>Regularization: Make Modifications</h1>
Double click on the word you want regularized, single click or type in the
word you want it regularized to.  Select
combination of Witnesses and Place.  Click OK when
finished.
<label for="reg_on" id="reg_on">Regularization is off! (Showing
originals)
</label>

<form action="." method="POST" name="regularization">
       <br /><label id="token1"> </label>
           <input type="text" name="token1Text" size="50"
           onclick="determineClick('token1Text')"
           style="visibility:hidden"/>
        <br /><label id="token2"></label>
           <input type="text" name="token2Text" size="50"
            onclick="determineClick('token2Text')" style="visibility:hidden"/>
       <br /><label id="token3"></label>
           <input type="text" name="token3Text" size="50"
           onclick="determineClick('token3Text')" style="visibility:hidden"/>
       <br /><label id="token4"></label>
           <input type="text" name="token4Text" size="50"
           onclick="determineClick('token4Text')" style="visibility:hidden"/>
       <br /><label id="token5"></label>
           <input type="text" name="token5Text" size="50"
           onclick="determineClick('token5Text')" style="visibility:hidden"/>
       <br /><label id="token6"></label>
           <input type="text" name="token6Text" size="50"
           onclick="determineClick('token6Text')" style="visibility:hidden"/>
       <br /><label id="token7"></label>
           <input type="text" name="token7Text" size="50"
           onclick="determineClick('token7Text')" style="visibility:hidden"/>
       <br /><label id="token8"></label>
           <input type="text" name="token8Text" size="50"
           onclick="determineClick('token8Text')" style="visibility:hidden"/>
       <br /><label id="token9"></label>
           <input type="text" name="token9Text" size="50"
           onclick="determineClick('token9Text')" style="visibility:hidden"/>
       <br /><label id="token10"></label>
           <input type="text" name="token10Text" size="50"
           onclick="determineClick('token10Text')" style="visibility:hidden"/>
       <br /><label id="token11"></label>
           <input type="text" name="token11Text" size="50"
           onclick="determineClick('token11Text')" style="visibility:hidden"/>
           
       <br /><label id="reg_this" name="reg_this">Regularize This:</label>
           <input type="text" name="reg_this" size="100"/>
       <br /><label id="reg_to">To This:</label>
           <input type="text" name="reg_to" size="100"/>

        <p>Regularize Choices:
       <select name="reg_choices">
	  <option value="this_block">All witnesses, this block</option>
	  <option value="this_word">All witnesses, this word</option>
	  <option value="all_places">All witnesses, all places</option>
	  <option value="other">Other ...</option>
	</select></p>

	<input name="ok" type="button" value="Add Rule"
	onclick="addrule()">
	<input name="edit_reg" type="button" value="Edit Reg.">
	<input name="reg_on" type="button" value="Reg. On"
	onclick="regularize_onoff()">
	<input name="recollate" type="submit"
        value="Recollate">
	<input name="back" type="button" value="Back" onclick="backToken()">
	<input name="next" type="button" value="Next" onclick="nextToken()">
	<input name="view" type="button" value="View Originals">
	<input name="done" type="button" value="DONE">
    </form>

</body> </html>
